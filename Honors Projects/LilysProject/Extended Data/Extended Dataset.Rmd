---
title: "Expanded Data"
author: "Lily Bright"
date: "11/8/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r cars}
#clear environment
rm(list=ls())

#import data
setwd("/Users/lilybright/Documents/PLNU/Honors 2022/R Files/Analysis")

#import data
SAR<- read.csv("Recs_1h_CR_Dataset01_North_Sarah_04Dez2022.csv")
me<- read.csv("Recs_1h_CR_Dataset01_South_Lily_04Dez2022.csv")
ELL<- read.csv("Recs_1h_CR_Dataset04_Lowland_Ellie_04Dez2022.csv")
EMI<- read.csv("Recs_1h_CR_Dataset02_Central_Emily_04Dez2022.csv")

#create master
master<-rbind(SAR, me, ELL, EMI)

lat<-unique(master$Latitud)
long<-unique(master$Longitd)

CTtot<-(master$Camr_Nm)
as.list(CTtot) #made list of CT

CT<-unique(master$Camr_Nm)


```


```{r}
##subset
Species<-unique(master$Species) #subsetted into species
coyote<-master[master$Species == "Canis latrans",] #subsetted into coyote records
ocelot<-master[master$Species == "Leopardus pardalis",] #subsetted into ocelot records

gps<- master[,c("Camr_Nm","Latitud","Longitd")]
class(gps) #dataframe
camll<-unique(gps)
camll<-as.data.frame(camll)


```


```{r}
coy<- coyote[,c("Camr_Nm","Latitud","Longitd")]
oce<- ocelot[,c("Camr_Nm","Latitud","Longitd")]
coy<-unique(coy)

coycam<-unique(coyote$Camr_Nm,coyote)
ocecam<-unique(ocelot$Camr_Nm)
```


```{r}
#####HAVENT GOTTEN HERE
(n.ocel<-sum(mydata$Ocelot, na.rm=T))
(n.coyo<-sum(mydata$Coyote, na.rm=T))
(n.both<-sum(mydata$Both, na.rm=T))
(n.none<-sum(mydata$None, na.rm=T))
(n.eith<-sum(mydata$Either, na.rm=T))

rnboth<- vector()
rnnone<- vector()
rneith<- vector()
for(i in 1:10000){
	s1<-sample(seq(1,nrow(mydata),1),nrow(mydata))
	s2<-sample(seq(1,nrow(mydata),1),nrow(mydata))
	nt<- cbind(mydata[s1,"Ocelot"],mydata[s2,"Coyote"])
	rnboth[i]<-sum(rowSums(nt,na.rm=T)==2)
	rnnone[i]<-sum(rowSums(nt,na.rm=T)==0)
	rneith[i]<-sum(rowSums(nt,na.rm=T)==1)
}
```



```{r}
plot(mydata$OcelotDetcs, mydata$CoyoteDetcs) #Keep it simple. We do not need ggplot.

m1<- glm(OcelotDetcs ~ CoyoteDetcs, data=mydata, family=poisson)
summary(m1)
m1<- glm(OcelotDetcs ~ CoyoteDetcs, data=mydata, family=poisson, offset=scale(mydata$DaysActive)) 	#the offset accounts for the fact that effort is not equal across CTs.

summary(m1) 	# Accounting for effort makes result slightly different

(var(mydata$OcelotDetcs)/mean(mydata$OcelotDetcs)) #Overdispersion? YES. In that case we should not use Poisson distribution, let's use something else

m2<- glm(OcelotDetcs ~ CoyoteDetcs, data=mydata, family=quasipoisson, offset=scale(mydata$DaysActive)) 	#Quasipoison Distribution
summary(m2)		# As expected the direction and effect size is very similar, but confidence interval is larger. 

library(MASS)
m3<- glm.nb(OcelotDetcs ~ CoyoteDetcs, data=mydata)		#Negative Binomial Distribution
summary(m3)		# The same as Quasipoisson.

# CONCLUSION: It seems like there is an effect, and based on our best model it is marginally significant. Maybe a bigger dataset would help us.
```


```{r}
# So far we have tested if there is a relationship between the number of detections of ocelots and the number of detections of coyotes.
# Let's try something different. If they are avoiding each other, the number of site that we have one species or the other shouls
#be higher than expected by chance, right? This is one hypothesis that is very easy to test. 

pa_Coyote<- mydata$CoyoteDetcs
pa_Coyote[pa_Coyote>1]<-1
pa_Ocelot<- mydata$OcelotDetcs
pa_Ocelot[pa_Ocelot>1]<-1
either<- pa_Ocelot + pa_Coyote
either[either>1]<-0 #wouldnt this be neither

rneith<- vector()
for(i in 1:3000){
	s1<-sample(seq(1,nrow(mydata),1),nrow(mydata))
	s2<-sample(seq(1,nrow(mydata),1),nrow(mydata))
	nt<- cbind(pa_Coyote[s1],pa_Ocelot[s2])
	rneith[i]<-sum(rowSums(nt,na.rm=T)==1)
}


plot(density(rneith), main="Either Coyote or Ocelot present (Either)")
abline(v = quantile(rneith, c(.05, .95)), col="grey", lwd=0.5, lty=2)
abline(v = sum(either,na.rm=T), col="red", lwd=1, lty=1)


# WOW... using this other approach it also seems like our result is a bit extreme in comparison to what would be expected if there was no avoidance.
# I guess it is worth investigating it.

# Another interesting aspect is to check if they avoid one another on a temporal scale. All we have done so far is spatial.

##if not avoiding there should be near the bottom of confidence level
#however it is above which implies there may be an affect
```


```{r}
#### Copied Old coding to compare to
##

# Importing detection histories from different datasets
cr1<- readRDS("ch_cr1_1d.rds")
cr2<- readRDS("ch_cr2_1d.rds")
cr3<- readRDS("ch_cr3_1d.rds")
cr4<- readRDS("ch_cr4_1d.rds")

recs_t<- rbind(cr1[[4]], cr2[[4]], cr3[[4]], cr4[[4]])
head(recs_t)
recs_t$hour<-format(as.POSIXct(recs_t$hour, format="%H:%M:%S"), "%H:%M")
ocelot.data<- recs_t[recs_t$species=="Leopardus pardalis", ]
coyote.data<- recs_t[recs_t$species=="Canis latrans", ]
library("overlap")
#transformando watch time to day time
timeToFraction<- function(time) {
t = unlist(strsplit(time, ":")) ## Function to convert times in the form hh:mm
n = length(time) # to fraction of the 24-hour day
hours = as.numeric(t[2*(1:n)-1])
minutes = as.numeric(t[2*(1:n)])
(hours + minutes/60) / 24
}
quote_hour<-matrix(recs_t$hour) # (ex.: "10:30")
f.hour<-round(timeToFraction(quote_hour),3)
range(f.hour)
timeRad<-f.hour*2*pi
mydata2<- cbind(recs_t, f.hour= round(f.hour,3), rad.hour= round(timeRad,3))
head(mydata2) #all species
ocelot.data<- mydata2[mydata2$species== "Leopardus pardalis",]
nrow(ocelot.data)
coyote.data<- mydata2[mydata2$species== "Canis latrans",]
nrow(coyote.data)

```


`